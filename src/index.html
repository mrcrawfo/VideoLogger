<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>VideoLogger</title>
        <script src="ejs_production.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="main.css">
        <script src="main.js"></script>
    </head>
    <body>
        <div class="footer">
            <button type="button" id="playlist_btn" class="btn btn-info" type="button">
                <span class="glyphicon glyphicon-list" aria-hidden="true"></span>
            </button>
            <button type="button" id="reset_btn" class="btn btn-danger" type="button">
                <span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span>
            </button>
            <a id="download_btn_link">
                <button type="button" id="download_btn" class="btn btn-primary" type="button">
                    <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                </button>
            </a>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-1"></div>
                <div class="col-md-6">
                    <div class="well" style="height:140px">
                        <label>YouTube URL:</label>
                        <input id="youtube_url" style="width:100%;float:left">
                        <input id="youtube_btn" style="margin-top:4px;float:right" class="btn btn-primary" type="button" value="Load Player">
                    </div>
                    <div style="width:100%;text-align:center">
                        <div id="player"></div>
                    </div>
                </div>
                <div class="col-md-1"></div>
                <div class="col-md-4">
                    <ul id="markerlist"></ul>
                </div>
            </div>
            <script>
                var markers = [];
                var id;
                var chapter = 1;
                var duration;
                
                var CATEGORY_1 = "Cutscene";
                var CATEGORY_2 = "Menu";
                var CATEGORY_3 = "Walk";
                var CATEGORY_4 = "Battle";
                
                // https://developers.google.com/youtube/iframe_api_reference
                
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                var player;
                var playerState;
                function onYouTubeIframeAPIReady() {
                    loadPlayer('qNSy091Otus');
                }

                function onPlayerReady(event) {
                    //event.target.playVideo();
                    var url = player.getVideoUrl();
                    if($('#youtube_url').val() != url) {
                        $('#youtube_url').val(url);
                    }
                    duration = player.getDuration();
                }

                function onPlayerStateChange(event) {
                    playerState = event.data;
                    if (event.data == YT.PlayerState.PLAYING) {
                        
                    }
                }
                
                function playVideo() {
                    player.playVideo();
                }
                
                function pauseVideo() {
                    player.pauseVideo();
                }
                
                function loadPlayer(videoId) {
                    id = videoId;
                    markers = storageRead();
                    exportCSV();
                    renderMarkers();
                    
                    if (player) {
                        player.loadVideoById(videoId, 0, 'medium');
                    } else {
                        player = new YT.Player('player', {
                            height: '400',
                            width: '640',
                            videoId: videoId,
                            events: {
                                'onReady': onPlayerReady,
                                'onStateChange': onPlayerStateChange
                            }
                        });
                    }
                }
                
                // https://stackoverflow.com/questions/3452546/how-do-i-get-the-youtube-video-id-from-a-url
                function youtube_parser(url){
                    var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/;
                    var match = url.match(regExp);
                    return (match&&match[7].length==11)? match[7] : false;
                }
                
                $('#youtube_btn').on('click', function (e) {
                    var videoId = youtube_parser($('#youtube_url').val());
                    
                    if (videoId && videoId != '' && videoId.length == 11) {
                        loadPlayer(videoId);
                    }
                });
                
                $('#playlist_btn').on('click', function (e) {
                    // show playlist modal
                });
                
                $('#reset_btn').on('click', function (e) {
                    storageClear();
                });
                
                $(document).keypress(function(e) {
                    if (playerState == 1) {
                        if(e.which == 49 || e.which == 97) {
                            addMarker(1, Math.floor(player.getCurrentTime()));
                        }
                        if(e.which == 50 || e.which == 115) {
                            addMarker(2, Math.floor(player.getCurrentTime()));
                        }
                        if(e.which == 51 || e.which == 100) {
                            addMarker(3, Math.floor(player.getCurrentTime()));
                        }
                        if(e.which == 52 || e.which == 102) {
                            addMarker(4, Math.floor(player.getCurrentTime()));
                        }
                        if(e.which == 43 || e.which == 93) {
                            chapter++;
                        }
                        if(e.which == 45 || e.which == 91) {
                            if(chapter > 1) {
                                chapter--;
                            }
                        }
                        if(e.which == 32) {
                            pauseVideo();
                        }
                    } else {
                        if(e.which == 32) {
                            playVideo();
                        }
                    }
                });
                
                function getTypeName(value) {
                    switch(value) {
                        case 1:
                            output = CATEGORY_1;
                            break;
                        case 2:
                            output = CATEGORY_2;
                            break;
                        case 3:
                            output = CATEGORY_3;
                            break;
                        case 4:
                            output = CATEGORY_4;
                            break;
                    }
                    return output;
                }
                
                function renderMarkers() {
                    var markerlist = $('#markerlist');
                    markerlist.empty();
                    for(var i = 0; i < markers.length; i++) {
                        markers[i].index = i;
                        var marker = new EJS({url:'templates/marker.ejs'}).render(markers[i]);
                        markerlist.append(marker);
                    }
                    $('#markerlist').animate({scrollTop: $('#markerlist').prop("scrollHeight")}, 600);
                }
                
                function updateMarker(index, marker) {
                    //$('#markerlist li').eq(index).remove();
                    markers[index] = marker;
                    storageWrite();
                    renderMarkers();
                }
                
                function removeMarker(index) {
                    markers.splice(index, 1);
                    storageWrite();
                    renderMarkers();
                }
                
                function addMarker(markerType, markerTime) {
                    var timecode = getTimecode(markerTime);
                    var marker = {type: markerType, time: markerTime, timecode: timecode, chapter: chapter};
                    
                    var replaceIndex = -1;
                    for(var i = 0; i < markers.length; i++) {
                        if(markers[i].time == markerTime) {
                            replaceIndex = i;
                        }
                    }
                    if(replaceIndex < 0) {
                        markers.push(marker);
                        markers.sort(timestampAscending);
                        storageWrite();
                        renderMarkers();
                    } else {
                        markers[replaceIndex] = marker;
                        updateMarker(replaceIndex, marker);
                    }
                }
                
                function getTimecode(seconds) {
                    var h = Math.floor(seconds / 3600);
                    var m = Math.floor(seconds / 60);
                    var s = seconds % 60;
                    return zerofill(h, 2) + ':' + zerofill(m, 2) + ':' + zerofill(s, 2);
                }
                
                function zerofill(value, digits) {
                    var output = '';
                    for(var i = 0; i < digits; i++) {
                        output += '0';
                    }
                    value = value.toString();
                    output = output.substr(value.length) + value;
                    return output;
                }
                
                function timestampAscending(a, b) {
                    if (a.time < b.time) {
                        return -1;
                    }
                    if (a.time > b.time) {
                        return 1;
                    }
                    return 0;
                }
                
                function storageWrite()
                {
                    var success = false;
                    
                    try
                    {
                        if(markers != null && markers.length > 0)
                        {
                            var storageString = JSON.stringify(markers);
                            window.localStorage.setItem(id, storageString);
                            exportCSV();
                            success = true;
                        }
                    } catch(e) {}
                    
                    return success;
                }
                
                function storageRead() {
                    var output = [];
                    
                    try
                    {
                        var data = JSON.parse(window.localStorage.getItem(id));
                        if (data && data.length > 0) {
                            output = data;
                        }
                    } catch(e) {}
                    
                    return output;
                }
                
                function storageClear() {
                    try
                    {
                        var storageString = JSON.stringify([]);
                        window.localStorage.setItem(id, storageString);
                        markers = [];
                        renderMarkers();
                    } catch(e) {}
                }
                
                function exportCSV() {
                    var markersArray = [['index', 'type', 'time', 'timecode', 'chapter']];
                    for(var i = 0; i < markers.length; i++) {
                        markersArray.push([markers[i].index, markers[i].type, markers[i].time, markers[i].timecode, markers[i].chapter]);
                    }
                    var csv = "data:text/csv;charset=utf-8,";
                    markersArray.forEach(function(rowArray){
                        let row = rowArray.join(",");
                        csv += row + "\r\n"; // add carriage return
                    });

                    var encodedUri = encodeURI(csv);
//                    window.open(encodedUri);
                    var link = document.getElementById('download_btn_link');
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", id + ".csv");
                }
            </script>
        </div>
    </body>
</html>